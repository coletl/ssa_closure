---
title: "Prepare Census data"
author: 
  - "Cole Tanigawa-Lau"
date: ""
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float: yes
  theme: paper
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 7, fig.height = 5)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r about, echo=FALSE, results = "asis"}
cat(
  sprintf("Updated: %s.", 
          format(Sys.time(), "%b %d, %Y at %H:%M:%S", usetz = TRUE)),
  sprintf("Working directory: `%s`.", getwd()),
  sep = "\n\n"
)
```


This script prepares the Census demographics for spatial joins with the annual service areas.

Compare linear interpolation between 5-year periods [interp(acs11, acs16)] to yearly ACS [acs11, acs12, acs13, etc.].


Reads:

  - data/acs/alltracts10-15_lng.rds
  - data/acs/alltracts17.rds
  - data/service_areas/*

Writes:

  - data/sf_interp/

# Setup

```{r packages, warning=FALSE, message=FALSE}
rm(list = ls())

library(dplyr)
library(tidyr)
library(data.table)
library(coler)
library(sf)
```

Variable info:

```{r}
var_dict <- 
  dplyr::tribble(~ variable,  ~ label, ~ descrip,
                 "B01001_001", "pop","population count",
                 
                 "B00001_001", "seniors","population 65+",
                 
                 "B99163_004", "english_imp","ability to speak english in population age 5+ (imputed)",
                 "B99163_005", "english","ability to speak english in population age 5+",
                 
                 "B06007_008", "less_english","speak english less than very well",
                 
                 "B25006_002", "white","householder who is white alone",
                 
                 "B28001_001", "computers","number of computers in household",
                 "B28001_011", "no_comp","no computer",
                 "B28002_013", "no_internet","no internet access",
                 
                 "B99151_001", "educ","educational attainment total",
                 "B99151_002", "educ_imp","educational attainment total imputed",
                 "B99151_003", "educ_noimp","educational attainment total not imputed",
                 
                 "B10052_001", "disabl_grand", "disability status of grandparents",
                 
                 
                 "B10052_001", "income_hh", "household income in past 12 months",
                 "B06011_001", "income_med", "median income in past 12 months",
                 "B16009_001", "poverty", "total poverty status in past 12 months",
                 "B10059_001", "poverty_grand", "total poverty status in past 12 months of childrearing grandparents",
                 
                 "B19057_001", "income_publ","public assistance income in past 12 months",
                 "B19055_001", "income_ss","social security income in past 12 months"
  )
```


# Prepare tract data

## ACS variables

```{r}
tract_lng <- readRDS("data/acs/alltracts10-15_lng.rds") %>% 
  left_join(var_dict, by = "variable")


tract <- 
  dcast(tract_lng[ , .(year, GEOID, label, estimate)], 
        year + GEOID ~ label, value.var = "estimate"
  )[ , 
     .(year, geoid = GEOID, 
       pop, educ, income_med, income_ss, poverty, poverty_grand,
       english, seniors, white)
  ]

```



## 2000 census

ACS 5-year survey (only one with nationwide coverage) didn't come out until 2010/2011. I need to add the 2000 census data and interpolate for years 2001-2010.
```{r}
# tract10 <- 
```


Pivot to wide format to match `sf` object.
```{r}
tract_wide <- 
  pivot_wider(tract, id_cols = geoid, names_from = year,
              values_from = setdiff(names(tract), c("geoid", "year")))
```

## 2017 computer variables

Merge with 2017 computer variables for every year. This data set contains the `sf` object that I need for spatial interpolation below.

```{r}
tract17 <- readRDS("data/acs/alltracts17.rds") %>% 
  dplyr::select(geoid = GEOID, state, 
                total_comp = B28001_001E, no_comp = B28001_011E, 
                total_internet = B28002_013E)
```

```{r}
tract_sf <- left_join(x = tract17, y = tract_wide, by = "geoid") %>% 
  st_transform(st_crs(3857))
```


# Interpolation

For a given state,
  
  1) Load tract demographics and all years' service areas
  2) Compute areal-weighted interpolation from each year's ACS variables to that year's service area
  3) Produce a data set of demographics at the office-year level with stationary computer variables from 2017

```{r}
tract_sfl <- split(tract_sf, tract_sf$state)

serv_sfl <- 
  list.files("data/service_areas", full = TRUE) %>% 
  lapply(readRDS)

names(serv_sfl) <- 
  map(serv_sfl, "state") %>% 
  sapply(unique)
```

Prepare for interplation, reduce workspace RAM usage.
```{r}
interp_fn <- "data/sf_interp/%s.rds"
tract_sfl_select <- map(tract_sfl, ~ dplyr::select(.x, matches("_20|comp|internet")))

rm(tract, tract17, tract_sf, tract_lng, tract_wide, tract_sfl)
gc()
```


Don't evaluate this chunk when knitting. It takes a very long time. For some reason, this failes on the polisci server, so I ran it on KBLY.

```{r eval = FALSE}
system.time(
  parallel::mclapply(names(tract_sfl_select), 
                     function(st){
                       interp <-
                         st_interpolate_aw(tract_sfl_select[[st]], 
                                           to = serv_sfl[[st]], 
                                           extensive = TRUE)
                       
                       out <- bind_cols(interp, serv_sfl[[st]] %>% 
                                          st_drop_geometry())
                       
                       # return(out)
                       saveRDS(out, sprintf(interp_fn, st))
                       
                     }, mc.cores = 2, mc.preschedule = FALSE
  )
)

# AK and AL in series
## user  system elapsed 
## 406.180   8.572 413.655 
```
